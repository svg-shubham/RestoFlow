{% extends 'base.html' %}
{% block content %}

<div class="container py-4">
    <h2 class="fw-bold mb-4 text-dark"><i class="bi bi-cash-stack me-2 text-success"></i>Cashier Counter</h2>

    <div class="modal fade" id="billRequestModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-bell-fill me-2"></i>New Bill Request!</h5>
                </div>
                <div class="modal-body text-center py-4">
                    <h1 class="display-1 text-danger"><i class="bi bi-receipt"></i></h1>
                    <h3 id="modalTableInfo" class="fw-bold">Table #--</h3>
                    <p class="text-muted">Manager ne is table ke liye bill request bheja hai.</p>
                </div>
                <div class="modal-footer border-0">
                    <a id="modalGenerateBtn" href="#" class="btn btn-danger btn-lg w-100 fw-bold">GENERATE BILL NOW</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4" id="orderContainer">
        {% for order in orders %}
        <div class="col-md-4">
            <div class="card shadow-sm border-0 {% if order.status == 'BILLING' %}border-top border-danger border-5{% endif %}">
                <div class="card-body">
                    <h4 class="fw-bold">Table {{ order.table.table_number }}</h4>
                    <p class="small text-muted mb-3">Status: {{ order.get_status_display }}</p>
                    <a href="{% url 'generate_invoice' order.id %}" class="btn btn-outline-dark w-100">View Details</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    let modalShowing = false;
    const billModal = new bootstrap.Modal(document.getElementById('billRequestModal'));
    const notifSound = document.getElementById('notifSound');

    function checkRequests() {
        fetch('/check-bill-requests/')  // Is URL ko urls.py mein add karna
            .then(response => response.json())
            .then(data => {
                if (data.new_requests && !modalShowing) {
                    const order = data.data[0]; // Pehla request uthao
                    document.getElementById('modalTableInfo').innerText = "Table #" + order.table_number;
                    document.getElementById('modalGenerateBtn').href = "/generate-invoice/" + order.order_id + "/";
                    
                    billModal.show();
                    notifSound.play(); // Notification sound bajega
                    modalShowing = true;
                }
            });
    }

    // Har 5 second mein check karo ki koi naya request aaya kya
    setInterval(checkRequests, 5000);

    // Modal close hone par status reset karo
    document.getElementById('billRequestModal').addEventListener('hidden.bs.modal', function () {
        modalShowing = false;
    });
</script>
{% endblock %}